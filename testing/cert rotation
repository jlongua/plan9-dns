-- serial file location
-- /var/lib/dnsdist/serial

-- read serial from file
local f = io.open("/var/lib/dnsdist/serial", "r")
local serial = tonumber(f:read())
f:close()

-- dnscrypt cert rotation
local last = os.time() - 7200
    function maintenance()
      local now = os.time()
      if ((now - last) > 21600) then
        serial = serial + 1
        generateDNSCryptCertificate(
          "/var/lib/dnsdist/providerPrivate.key",
          "/var/lib/dnsdist/resolver.cert",
          "/var/lib/dnsdist/resolver.key",
          serial, now - 60, now + 43200,
          DNSCryptExchangeVersion.VERSION2)
        getDNSCryptBind(0):loadNewCertificate(
          '/var/lib/dnsdist/resolver.cert',
          '/var/lib/dnsdist/resolver.key')
        last = now
        local f = io.open("/var/lib/dnsdist/serial", "w+")
        f:write(serial)
        f:close()
      end
    dbr:apply()
    end
